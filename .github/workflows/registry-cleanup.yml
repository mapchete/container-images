name: registry cleanup
on:
  workflow_run:
    workflows: ["docker build"]
    types: [completed]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      packages: write
    strategy:
      matrix:
        image-name: [mapchete, mhub-cli-light, mhub-cli-full]
    steps:
      - name: Purge Untagged Manifests
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORG="mapchete"
          PKG="${{ matrix.image-name }}"
          echo "Cleaning $ORG/$PKG..."
          UNTAGGED_VERSIONS=$(gh api --paginate /orgs/$ORG/packages/container/$PKG/versions --jq '.[] | select(.metadata.container.tags | length == 0) | .id')
          if [ -z "$UNTAGGED_VERSIONS" ]; then
            echo "No untagged versions found."
          else
            for ID in $UNTAGGED_VERSIONS; do
              echo "Deleting version: $ID"
              gh api --method DELETE /orgs/$ORG/packages/container/$PKG/versions/$ID || true
            done
          fi